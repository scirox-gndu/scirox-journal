<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Scirox Lab Journal</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Google Fonts: Handwriting and Typewriter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Indie+Flower&family=Patrick+Hand&family=Special+Elite&display=swap" rel="stylesheet">
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        /* --- Diary / Journal Aesthetic --- */
        body {
            background-color: #2d2a26; /* Dark wood desk feeling */
            background-image: url("https://www.transparenttextures.com/patterns/wood-pattern.png");
            font-family: 'Patrick Hand', cursive;
        }

        .journal-binder {
            background-color: #fdfbf7;
            background-image: 
                linear-gradient(#e1e1e1 1px, transparent 1px),
                linear-gradient(90deg, #e1e1e1 1px, transparent 1px);
            background-size: 20px 20px;
            background-position: 0 0;
            box-shadow: 
                0 0 0 5px #4a4a4a, /* Thinner edge for mobile */
                5px 5px 15px rgba(0,0,0,0.5);
            position: relative;
            min-height: 100vh; /* Full height on mobile */
            transition: all 0.3s ease;
        }

        /* Red margin line - Mobile First (30px), Desktop (60px) */
        .journal-binder::before {
            content: '';
            position: absolute;
            top: 0;
            bottom: 0;
            left: 30px;
            width: 2px;
            background-color: #ff9999;
            z-index: 10;
        }

        @media (min-width: 768px) {
            .journal-binder {
                box-shadow: 
                    0 0 0 10px #4a4a4a,
                    10px 10px 30px rgba(0,0,0,0.5);
                min-height: 90vh;
            }
            .journal-binder::before {
                left: 60px;
            }
        }

        .font-typewriter {
            font-family: 'Special Elite', monospace;
        }
        
        .font-handwriting {
            font-family: 'Indie Flower', cursive;
        }

        /* --- READABLE MODE OVERRIDES --- */
        .readable-mode .font-handwriting {
            font-family: ui-sans-serif, system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif !important;
            font-size: 1.05rem !important; /* Slightly larger for readability */
            line-height: 1.6 !important;
            letter-spacing: normal !important;
        }
        
        .readable-mode .font-typewriter {
            font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace !important;
            font-weight: 700;
        }

        /* Paper Card Style */
        .entry-card {
            background: #fff;
            box-shadow: 2px 3px 5px rgba(0,0,0,0.1);
            border: 1px solid #e0e0e0;
            transition: transform 0.2s;
            position: relative;
        }
        
        .entry-card:hover {
            transform: rotate(-1deg) scale(1.01);
            box-shadow: 4px 6px 10px rgba(0,0,0,0.15);
            z-index: 5;
        }

        /* Tape effect for admin posts */
        .tape-section {
            position: absolute;
            top: -10px;
            left: 50%;
            transform: translateX(-50%);
            width: 100px;
            height: 30px;
            background-color: rgba(255, 255, 255, 0.4);
            border-left: 1px dashed rgba(0,0,0,0.1);
            border-right: 1px dashed rgba(0,0,0,0.1);
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            z-index: 10;
        }

        .ink-blue { color: #1a237e; }
        .ink-red { color: #b71c1c; }
        .ink-black { color: #212121; }

        /* Sort Tab Active Style */
        .sort-tab.active {
            border-bottom: 3px solid #0891b2; /* cyan-600 */
            color: #0891b2;
            font-weight: bold;
        }
        .sort-tab {
            border-bottom: 3px solid transparent;
            color: #78716c; /* stone-500 */
            cursor: pointer;
            transition: all 0.3s;
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 10px;
        }
        ::-webkit-scrollbar-track {
            background: #2d2a26;
        }
        ::-webkit-scrollbar-thumb {
            background: #8d6e63;
            border-radius: 5px;
        }
    </style>
</head>
<body class="p-0 md:p-8">

    <!-- App Container -->
    <!-- Note: .readable-mode class will be toggled here via JS -->
    <div id="app">
        <!-- Content injected by JS -->
    </div>

    <!-- Firebase Logic -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { 
            getFirestore, 
            collection, 
            addDoc, 
            onSnapshot, 
            query, 
            orderBy, 
            doc, 
            updateDoc, 
            deleteDoc, 
            arrayUnion, 
            arrayRemove,
            increment,
            serverTimestamp,
            Timestamp 
        } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

        // --- Configuration ---
        const firebaseConfig = {
            apiKey: "AIzaSyB4eoofAdY4DrW-VKvfGJl5aNv2hoCTn4c",
            authDomain: "iist-fd6e8.firebaseapp.com",
            databaseURL: "https://iist-fd6e8-default-rtdb.firebaseio.com",
            projectId: "iist-fd6e8",
            storageBucket: "iist-fd6e8.firebasestorage.app",
            messagingSenderId: "692699808449",
            appId: "1:692699808449:web:120c8941a940d071f24a40",
            measurementId: "G-GPFG8LWF2H"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        // --- State Management ---
        const state = {
            user: null,
            ideas: [],
            loading: true,
            isAdmin: false,
            showForm: false,
            expandedCards: new Set(),
            sortBy: 'newest', // 'newest' or 'rank'
            readableFont: localStorage.getItem('scirox_readable_font') === 'true' // Load preference
        };

        // --- DOM Elements ---
        const appContainer = document.getElementById('app');

        // --- Helper Functions ---
        const formatDate = (timestamp) => {
            if (!timestamp) return 'Just now';
            const date = timestamp.toDate ? timestamp.toDate() : new Date(timestamp);
            return date.toLocaleDateString('en-US', { 
                weekday: 'short', month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' 
            });
        };

        const sortIdeas = (ideas) => {
            if (state.sortBy === 'rank') {
                return [...ideas].sort((a, b) => (b.score || 0) - (a.score || 0));
            }
            // Default newest
            return [...ideas].sort((a, b) => {
                const tA = a.createdAt?.toMillis() || 0;
                const tB = b.createdAt?.toMillis() || 0;
                return tB - tA;
            });
        };

        // --- Render Functions ---
        
        function render() {
            // Apply font class to container
            const containerClass = `max-w-4xl mx-auto journal-binder rounded-none md:rounded-r-2xl overflow-hidden flex flex-col ${state.readableFont ? 'readable-mode' : ''}`;

            if (state.loading) {
                appContainer.className = containerClass;
                appContainer.innerHTML = `
                    <div class="flex-1 flex items-center justify-center min-h-[50vh]">
                        <div class="text-center">
                            <i data-lucide="loader-2" class="w-12 h-12 animate-spin text-stone-500 mx-auto mb-2"></i>
                            <p class="font-typewriter text-stone-500">Opening Journal...</p>
                        </div>
                    </div>`;
                lucide.createIcons();
                return;
            }

            // Header with Sorting & Controls
            const headerHTML = `
                <header class="p-6 md:p-8 pb-4 pl-12 md:pl-24 border-b-2 border-stone-300 relative bg-stone-50/50">
                    <div class="flex flex-col md:flex-row justify-between items-start gap-4 md:gap-0">
                        <div>
                            <h1 class="text-3xl md:text-5xl font-typewriter font-bold text-stone-800 tracking-tighter" style="transform: rotate(-1deg);">
                                SCIROX LOGBOOK
                            </h1>
                            <p class="text-lg md:text-xl text-stone-500 font-handwriting mt-1 ml-1 md:ml-2">Field Notes & Ideas - GNDU</p>
                        </div>
                        
                        <!-- Top Right Controls -->
                        <div class="absolute top-6 right-6 md:static flex gap-2">
                             <!-- Font Toggle Button -->
                             <button onclick="window.toggleFont()" 
                                class="p-2 rounded-full hover:bg-stone-200 transition-colors ${state.readableFont ? 'text-blue-600 bg-blue-50' : 'text-stone-400'}"
                                title="${state.readableFont ? 'Switch to Handwriting' : 'Switch to Readable Font'}">
                                <i data-lucide="${state.readableFont ? 'pen-tool' : 'type'}" class="w-6 h-6"></i>
                            </button>
                        </div>
                    </div>

                    <!-- Intro Sticker -->
                    <div class="mt-4 bg-yellow-100 p-3 transform rotate-1 shadow-sm w-full md:max-w-lg border border-yellow-200 mb-6">
                        <p class="font-handwriting text-base text-stone-700 leading-tight">
                            ${state.isAdmin 
                                ? "<strong class='text-red-700'>ADMIN ACCESS:</strong> You can remove pages (delete) and write official notes (bold)." 
                                : "<strong>To all members:</strong> This journal is for recording experiment ideas, workshop proposals, and scientific queries. The Core Team checks this daily."}
                        </p>
                    </div>

                    <!-- Sorting Tabs & Stats -->
                    <div class="flex flex-wrap items-end justify-between border-b border-stone-200">
                        <div class="flex gap-6 font-typewriter text-sm md:text-base">
                            <button onclick="window.setSort('newest')" class="sort-tab pb-2 ${state.sortBy === 'newest' ? 'active' : ''}">
                                <i data-lucide="clock" class="w-4 h-4 inline mb-0.5 mr-1"></i> Newest
                            </button>
                            <button onclick="window.setSort('rank')" class="sort-tab pb-2 ${state.sortBy === 'rank' ? 'active' : ''}">
                                <i data-lucide="trophy" class="w-4 h-4 inline mb-0.5 mr-1"></i> Top Ranked
                            </button>
                        </div>
                        
                        <!-- Total Count Display & Hidden Lock -->
                        <div class="pb-2 font-typewriter text-xs md:text-sm text-stone-400 flex items-center gap-2">
                            <span>Total Pages: <span class="text-stone-600 font-bold">${state.ideas.length}</span></span>
                            
                            <!-- Hidden Admin Lock -->
                            <button onclick="window.toggleAdmin()" 
                                class="opacity-10 hover:opacity-100 transition-opacity p-1 ${state.isAdmin ? 'text-red-600 opacity-100' : 'text-stone-400'}"
                                title="Admin Access">
                                <i data-lucide="${state.isAdmin ? 'unlock' : 'lock'}" class="w-3 h-3"></i>
                            </button>
                        </div>
                    </div>

                    <!-- FAB -->
                    <button onclick="window.toggleForm()" class="absolute -bottom-5 right-4 md:-bottom-6 md:right-8 bg-blue-600 text-white p-3 md:p-4 rounded-full shadow-lg hover:bg-blue-700 hover:scale-110 transition-all transform z-20 group">
                        <i data-lucide="${state.showForm ? 'x' : 'plus'}" class="w-6 h-6 group-hover:rotate-90 transition-transform"></i>
                    </button>
                </header>
            `;

            // Form
            let formHTML = '';
            if (state.showForm) {
                formHTML = `
                    <div class="mx-4 md:mx-20 mt-8 mb-4 p-4 md:p-6 bg-white border-2 border-dashed border-stone-300 relative shadow-inner animate-fade-in">
                        <div class="absolute -top-3 left-1/2 -translate-x-1/2 bg-stone-200 px-3 py-1 text-xs font-typewriter text-stone-500 uppercase tracking-widest whitespace-nowrap">New Entry</div>
                        <form onsubmit="window.submitIdea(event)" class="space-y-4">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label class="block font-typewriter text-xs text-stone-400 mb-1">SUBJECT</label>
                                    <input type="text" id="newTitle" required 
                                        class="w-full bg-transparent border-b-2 border-stone-200 focus:border-blue-500 outline-none font-handwriting text-xl py-1 text-stone-800"
                                        placeholder="${state.isAdmin ? 'URGENT NOTICE' : 'e.g. Astronomy Night'}">
                                </div>
                                <div>
                                    <label class="block font-typewriter text-xs text-stone-400 mb-1">RESEARCHER</label>
                                    <input type="text" id="newAuthor" 
                                        class="w-full bg-transparent border-b-2 border-stone-200 focus:border-blue-500 outline-none font-handwriting text-xl py-1 text-stone-800"
                                        placeholder="Your Name"
                                        value="${state.isAdmin ? 'Scirox Core Team' : ''}" ${state.isAdmin ? 'disabled' : ''}>
                                </div>
                            </div>
                            <div>
                                <label class="block font-typewriter text-xs text-stone-400 mb-1">OBSERVATIONS / DETAILS</label>
                                <textarea id="newDesc" required rows="3"
                                    class="w-full bg-stone-50 border border-stone-200 rounded p-2 focus:border-blue-500 outline-none font-handwriting text-lg text-stone-800 leading-relaxed ${state.isAdmin ? 'font-bold text-red-800' : ''}"
                                    placeholder="Write your findings here..."></textarea>
                            </div>
                            <div class="flex justify-end">
                                <button type="submit" class="bg-stone-800 text-white px-6 py-2 rounded-sm font-typewriter text-sm hover:bg-stone-700 transition-colors flex items-center gap-2 w-full md:w-auto justify-center">
                                    <i data-lucide="save" class="w-4 h-4"></i> SAVE ENTRY
                                </button>
                            </div>
                        </form>
                    </div>
                `;
            }

            // Sorted Ideas
            const sortedIdeas = sortIdeas(state.ideas);
            const ideasHTML = sortedIdeas.length === 0 
                ? `<div class="text-center py-20 opacity-50 font-handwriting text-xl md:text-2xl px-4 pl-12 md:pl-16">
                    The pages are empty. Waiting for data...
                   </div>`
                : `<div class="space-y-6 md:space-y-8 px-4 md:px-20 py-8 pb-24 md:pb-20">
                    ${sortedIdeas.map(idea => renderIdeaCard(idea)).join('')}
                   </div>`;

            appContainer.className = containerClass;
            appContainer.innerHTML = headerHTML + formHTML + ideasHTML;
            lucide.createIcons();
        }

        function renderIdeaCard(idea) {
            const isExpanded = state.expandedCards.has(idea.id);
            const isAnnouncement = idea.isAdmin;
            
            // Voting State
            const uid = state.user ? state.user.uid : null;
            const upvoted = idea.upvoters?.includes(uid);
            const downvoted = idea.downvoters?.includes(uid);
            const score = idea.score || 0;

            // Generate HTML for replies
            const repliesHTML = (idea.replies || []).map(reply => `
                <div class="flex gap-3 mb-3 group">
                    <div class="mt-1 ${reply.isAdmin ? 'text-red-600' : 'text-blue-600'}">
                        <i data-lucide="${reply.isAdmin ? 'shield-check' : 'user'}" class="w-4 h-4"></i>
                    </div>
                    <div class="flex-1 border-b border-stone-200 pb-2">
                        <div class="flex flex-col md:flex-row justify-between md:items-baseline gap-1 md:gap-0">
                            <span class="font-typewriter text-xs font-bold ${reply.isAdmin ? 'text-red-700' : 'text-stone-600'}">
                                ${reply.author}
                            </span>
                            <span class="font-typewriter text-[10px] text-stone-400">${formatDate(reply.createdAt)}</span>
                        </div>
                        <p class="font-handwriting text-lg leading-6 ${reply.isAdmin ? 'font-bold text-stone-900' : 'text-stone-700'}">
                            ${reply.text}
                        </p>
                    </div>
                </div>
            `).join('');

            return `
                <div class="entry-card rounded-sm ${isAnnouncement ? 'border-l-4 border-l-red-500 bg-red-50/30' : ''} ml-6 md:ml-0 flex">
                    ${isAnnouncement ? '<div class="tape-section"></div>' : ''}
                    
                    ${state.isAdmin ? `
                        <button onclick="window.deleteIdea('${idea.id}')" class="absolute top-2 right-2 p-2 text-stone-300 hover:text-red-600 transition-colors z-10" title="Tear out page">
                            <i data-lucide="trash-2" class="w-5 h-5"></i>
                        </button>
                    ` : ''}

                    <!-- Vote Column -->
                    <div class="w-12 bg-stone-50 border-r border-dashed border-stone-200 flex flex-col items-center pt-4 gap-1">
                        <button onclick="window.vote('${idea.id}', 'up')" 
                            class="p-1 rounded hover:bg-stone-200 transition-colors ${upvoted ? 'text-green-600 font-bold' : 'text-stone-400'}">
                            <i data-lucide="chevron-up" class="w-6 h-6"></i>
                        </button>
                        
                        <span class="font-typewriter font-bold text-lg ${score > 0 ? 'text-stone-800' : (score < 0 ? 'text-red-500' : 'text-stone-400')}">
                            ${score}
                        </span>

                        <button onclick="window.vote('${idea.id}', 'down')"
                            class="p-1 rounded hover:bg-stone-200 transition-colors ${downvoted ? 'text-red-500 font-bold' : 'text-stone-400'}">
                            <i data-lucide="chevron-down" class="w-6 h-6"></i>
                        </button>
                    </div>

                    <!-- Content Column -->
                    <div class="flex-1 p-4 md:p-6">
                        <div class="flex flex-col mb-4">
                            <div class="flex flex-wrap items-center gap-2 mb-1">
                                <span class="bg-stone-200 text-stone-600 text-[10px] font-typewriter px-2 py-0.5 rounded">ENTRY #${idea.id.slice(0,4)}</span>
                                <span class="text-stone-400 font-handwriting text-sm">${formatDate(idea.createdAt)}</span>
                            </div>
                            <h3 class="text-xl md:text-2xl font-bold font-typewriter ${isAnnouncement ? 'text-red-700' : 'text-stone-800'} mt-1">
                                ${idea.title}
                            </h3>
                            <p class="text-sm font-handwriting text-stone-500">Recorded by: <span class="border-b border-stone-300">${idea.author}</span></p>
                        </div>

                        <div class="font-handwriting text-lg md:text-xl leading-relaxed mb-6 ${isAnnouncement ? 'font-bold text-stone-900' : 'text-stone-800'}" style="white-space: pre-wrap;">${idea.description}</div>

                        <!-- Footer -->
                        <div class="border-t-2 border-dashed border-stone-200 pt-3">
                            <button onclick="window.toggleReplies('${idea.id}')" class="flex items-center gap-2 text-stone-500 hover:text-blue-600 transition-colors w-full md:w-auto">
                                <i data-lucide="message-square" class="w-4 h-4"></i>
                                <span class="font-typewriter text-xs uppercase tracking-wider">
                                    Field Notes (${idea.replies ? idea.replies.length : 0})
                                </span>
                                <i data-lucide="${isExpanded ? 'chevron-up' : 'chevron-down'}" class="w-4 h-4 ml-auto md:ml-0"></i>
                            </button>

                            ${isExpanded ? `
                                <div class="mt-4 bg-stone-50 p-3 md:p-4 rounded-sm border border-stone-100">
                                    ${repliesHTML.length > 0 ? repliesHTML : '<p class="text-stone-400 font-handwriting text-center">No notes added yet.</p>'}
                                    
                                    <form onsubmit="window.submitReply(event, '${idea.id}')" class="mt-4 flex flex-col gap-2 pl-0 md:pl-7">
                                        ${!state.isAdmin ? `
                                            <input type="text" name="replyAuthor" placeholder="Your Name" 
                                            class="bg-transparent border-b border-stone-300 text-sm font-handwriting py-1 w-full md:w-1/2 outline-none focus:border-blue-500">
                                        ` : '<div class="text-xs font-bold text-red-600 font-typewriter">REPLYING AS ADMIN</div>'}
                                        
                                        <div class="flex flex-col md:flex-row gap-2">
                                            <input type="text" name="replyText" placeholder="Add a margin note..." required
                                                class="flex-1 bg-transparent border-b border-stone-300 font-handwriting text-lg py-1 outline-none focus:border-blue-500 ${state.isAdmin ? 'font-bold text-red-800' : ''}">
                                            <button type="submit" class="text-stone-400 hover:text-stone-800 transition-colors p-2 md:p-0 flex items-center justify-center md:block">
                                                <i data-lucide="send" class="w-5 h-5"></i>
                                            </button>
                                        </div>
                                    </form>
                                </div>
                            ` : ''}
                        </div>
                    </div>
                </div>
            `;
        }

        // --- Window/Global Actions ---

        window.setSort = (type) => {
            state.sortBy = type;
            render();
        };

        window.toggleFont = () => {
            state.readableFont = !state.readableFont;
            localStorage.setItem('scirox_readable_font', state.readableFont);
            render();
        };

        window.toggleAdmin = () => {
            if (state.isAdmin) {
                state.isAdmin = false;
                render();
            } else {
                const pass = prompt("Enter Core Team Password:");
                if (pass === "qwertyjohn") {
                    state.isAdmin = true;
                    alert("Journal Access: UNLOCKED");
                    render();
                } else if (pass !== null) {
                    alert("Access Denied");
                }
            }
        };

        window.toggleForm = () => {
            state.showForm = !state.showForm;
            render();
        };

        window.toggleReplies = (id) => {
            if (state.expandedCards.has(id)) {
                state.expandedCards.delete(id);
            } else {
                state.expandedCards.add(id);
            }
            render();
        };

        window.submitIdea = async (e) => {
            e.preventDefault();
            const title = document.getElementById('newTitle').value;
            const author = document.getElementById('newAuthor').value;
            const desc = document.getElementById('newDesc').value;

            if (!title || !desc) return;

            try {
                await addDoc(collection(db, "scirox_ideas"), {
                    title: title,
                    description: desc,
                    author: state.isAdmin ? 'Scirox Core Team' : (author || 'Anonymous Researcher'),
                    isAdmin: state.isAdmin,
                    createdAt: serverTimestamp(),
                    replies: [],
                    score: 0,
                    upvoters: [],
                    downvoters: []
                });
                state.showForm = false;
                render();
            } catch (err) {
                console.error(err);
                alert("Error writing to journal.");
            }
        };

        window.vote = async (id, type) => {
            if (!state.user) {
                alert("Connecting to database... please wait.");
                return;
            }
            const uid = state.user.uid;
            const idea = state.ideas.find(i => i.id === id);
            if (!idea) return;

            // Check if already voted
            const isUp = idea.upvoters?.includes(uid);
            const isDown = idea.downvoters?.includes(uid);
            const ref = doc(db, "scirox_ideas", id);

            try {
                if (type === 'up') {
                    if (isUp) {
                        // Toggle OFF (remove upvote)
                        await updateDoc(ref, {
                            upvoters: arrayRemove(uid),
                            score: increment(-1)
                        });
                    } else if (isDown) {
                        // Switch (remove down, add up)
                        await updateDoc(ref, {
                            downvoters: arrayRemove(uid),
                            upvoters: arrayUnion(uid),
                            score: increment(2) // +1 to neutralize down, +1 for up
                        });
                    } else {
                        // New Upvote
                        await updateDoc(ref, {
                            upvoters: arrayUnion(uid),
                            score: increment(1)
                        });
                    }
                } else if (type === 'down') {
                    if (isDown) {
                        // Toggle OFF (remove downvote)
                        await updateDoc(ref, {
                            downvoters: arrayRemove(uid),
                            score: increment(1)
                        });
                    } else if (isUp) {
                        // Switch (remove up, add down)
                        await updateDoc(ref, {
                            upvoters: arrayRemove(uid),
                            downvoters: arrayUnion(uid),
                            score: increment(-2)
                        });
                    } else {
                        // New Downvote
                        await updateDoc(ref, {
                            downvoters: arrayUnion(uid),
                            score: increment(-1)
                        });
                    }
                }
            } catch (err) {
                console.error("Voting error", err);
            }
        };

        window.submitReply = async (e, ideaId) => {
            e.preventDefault();
            const form = e.target;
            const text = form.replyText.value;
            const authorInput = form.replyAuthor;
            const authorName = state.isAdmin ? 'Scirox Core Team' : (authorInput ? authorInput.value : 'Fellow Member') || 'Fellow Member';

            if (!text) return;

            try {
                const ideaRef = doc(db, "scirox_ideas", ideaId);
                await updateDoc(ideaRef, {
                    replies: arrayUnion({
                        text: text,
                        author: authorName,
                        isAdmin: state.isAdmin,
                        createdAt: Timestamp.now()
                    })
                });
                render();
            } catch (err) {
                console.error(err);
            }
        };

        window.deleteIdea = async (id) => {
            if (confirm("Tear out this page permanently? This cannot be undone.")) {
                try {
                    await deleteDoc(doc(db, "scirox_ideas", id));
                } catch (err) {
                    console.error(err);
                }
            }
        };

        // --- Initialization ---
        async function init() {
            render(); // Show loading
            
            // 1. Auth
            try {
                await signInAnonymously(auth);
            } catch (err) {
                console.error("Auth error", err);
            }

            // 2. Listeners
            onAuthStateChanged(auth, (user) => {
                state.user = user;
                if (user) {
                    // Fetch all and sort client-side to avoid complex index requirements for dynamic sorting
                    const q = query(collection(db, "scirox_ideas")); 
                    onSnapshot(q, (snapshot) => {
                        state.ideas = snapshot.docs.map(d => ({id: d.id, ...d.data()}));
                        state.loading = false;
                        render();
                    });
                }
            });
        }

        init();
    </script>
</body>
</html>
